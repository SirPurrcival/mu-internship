from functions import Network, raster, rate, approximate_lfp_timecourse, get_isi, get_irregularity, get_synchrony, get_firing_rate, join_results, prep_spikes
import numpy as np
import pickle

def setup():
    #######################################
    ## Set parameters for the simulation ##
    #######################################
    
    ## Recording and simulation parameters
    params = {
        'rec_start'  :   600.,                                                      # start point for data recording
        'rec_stop'   :   800.,                                                      # end points for data recording
        'sim_time'   :  1000.,                                                      # Time the network is simulated in ms
        'calc_lfp'   :  False,                                                      # Flag to use LFP approximation procedure
        'verbose'    :  True,                                                      # Flag for verbose function output
        'K_scale'    :     .15,                                                      # Scaling factor for connections
        'syn_scale'  :     1.,                                                      # Scaling factor for synaptic strenghts
        'N_scale'    :     .2,                                                      # Scaling factor for the number of neurons
        'R_scale'    :     0.1,                                                      # Fraction of neurons to be recorded from
        'opt_run'    :   False,                                                      # Flag for optimizer run, run minimal settings
        'num_neurons': np.array([776, 47386, 3876, 2807, 6683, 70387, 9502, 5455,   # Number of neurons by population
                          2640, 20740, 2186, 1958, 410, 19839, 1869, 1869, 325]),
        'label'      : ['Htr','E','Pv','Sst','Htr','E','Pv','Sst','Htr','E','Pv',   # Label for the populations
                        'Sst','Htr','E','Pv','Sst','Htr'],
        'cell_type'  : np.load('cells.npy', allow_pickle=True).item(),              # cell types, courtesy of the allen institute
        'layer_type' : ['L1_Htr3a',                                                 # Layer and cell types
                        'L23_E', 'L23_Pvalb', 'L23_Sst', 'L23_Htr3a',
                        'L4_E', 'L4_Pvalb', 'L4_Sst', 'L4_Htr3a',  
                        'L5_E', 'L5_Pvalb', 'L5_Sst', 'L5_Htr3a', 
                        'L6_E', 'L6_Pvalb',  'L6_Sst', 'L6_Htr3a']
        }
    
    ################################################################
    ## Specify connectivity in and between layers and populations ##
    ################################################################
    
    # Connectivity matrix layertype X layertype
    params['connectivity'] = np.array([[0.656, 0.356, 0.093, 0.068, 0.4644, 0.148, 0    , 0    , 0    , 0.148, 0    , 0    , 0    , 0.148, 0    , 0    , 0    ],
                                      [0    , 0.16 , 0.395, 0.182, 0.105 , 0.016, 0.083, 0.083, 0.083, 0.083, 0.081, 0.102, 0    , 0    , 0    , 0    , 0    ],
                                      [0.024, 0.411, 0.451, 0.03 , 0.22  , 0.05 , 0.05 , 0.05 , 0.05 , 0.07 , 0.073, 0    , 0    , 0    , 0    , 0    , 0    ],
                                      [0.279, 0.424, 0.857, 0.082, 0.77  , 0.05 , 0.05 , 0.05 , 0.05 , 0.021, 0    , 0    , 0    , 0    , 0    , 0    , 0    ],
                                      [0    , 0.087, 0.02 , 0.625, 0.028 , 0.05 , 0.05 , 0.05 , 0.05 , 0    , 0    , 0    , 0    , 0    , 0    , 0    , 0    ],
                                      [0    , 0.14 , 0.100, 0.1  , 0.1   , 0.243, 0.43 , 0.571, 0.571, 0.104, 0.101, 0.128, 0.05 , 0.032, 0    , 0    , 0    ],
                                      [0    , 0.25 , 0.050, 0.05 , 0.05  , 0.437, 0.451, 0.03 , 0.22 , 0.088, 0.091, 0.03 , 0.03 , 0    , 0    , 0    , 0    ],
                                      [0.241, 0.25 , 0.050, 0.05 , 0.05  , 0.351, 0.857, 0.082, 0.77 , 0.026, 0.03 , 0    , 0.03 , 0    , 0    , 0    , 0    ],
                                      [0    , 0.25 , 0.050, 0.05 , 0.05  , 0.351, 0.02 , 0.625, 0.028, 0    , 0.03 , 0.03 , 0.03 , 0    , 0    , 0    , 0    ],
                                      [0.017, 0.021, 0.05 , 0.05 , 0.05  , 0.007, 0.05 , 0.05 , 0.05 , 0.116, 0.083, 0.063, 0.105, 0.047, 0.03 , 0.03 , 0.03 ],
                                      [0    , 0    , 0.102, 0    , 0     , 0    , 0.034, 0.03 , 0.03 , 0.455, 0.361, 0.03 , 0.22 , 0.03 , 0.01 , 0.01 , 0.01 ],
                                      [0.203, 0.169, 0    , 0.017, 0     , 0.056, 0.03 , 0.006, 0.03 , 0.317, 0.857, 0.04 , 0.77 , 0.03 , 0.01 , 0.01 , 0.01 ],
                                      [0    , 0    , 0    , 0    , 0     , 0.03 , 0.03 , 0.03 , 0.03 , 0.125, 0.02 , 0.625, 0.02 , 0.03 , 0.01 , 0.01 , 0.01 ],
                                      [0    , 0    , 0    , 0    , 0     , 0    , 0    , 0    , 0    , 0.012, 0.01 , 0.01 , 0.01 , 0.026, 0.145, 0.1  , 0.1  ],
                                      [0    , 0.1  , 0    , 0    , 0     , 0.1  , 0    , 0    , 0    , 0.1  , 0.03 , 0.03 , 0.03 , 0.1  , 0.08 , 0.1  , 0.08 ],
                                      [0    , 0    , 0    , 0    , 0     , 0    , 0    , 0    , 0    , 0.03 , 0.03 , 0.03 , 0.03 , 0.1  , 0.05 , 0.05 , 0.05 ],
                                      [0    , 0    , 0    , 0    , 0     , 0    , 0    , 0    , 0    , 0.03 , 0.03 , 0.03 , 0.03 , 0.1  , 0.05 , 0.05 , 0.03 ]])
    
    ################################
    ## Specify synapse properties ##
    ################################
    
    params['syn_type'] = np.array([["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E"], 
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E"], 
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E"], 
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E","E"], 
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"],
                                      ["I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I","I"]])
    
    params['syn_strength'] = np.array([[1.73, 0.53, 0.48, 0.57, 0.78, 0.42, 0   , 0   , 0   , 0.42, 0   , 0   , 0   , 0.42, 0   , 0   , 0   ],
                                       [0   , 0.36, 1.49, 0.86, 1.31, 0.34, 1.39, 0.69, 0.91, 0.74, 1.32, 0.53, 0   , 0   , 0   , 0   , 0   ],
                                       [0.37, 0.48, 0.68, 0.42, 0.41, 0.56, 0.68, 0.42, 0.41, 0.2 , 0.79, 0   , 0   , 0   , 0   , 0   , 0   ],
                                       [0.47, 0.31, 0.5 , 0.15, 0.52, 0.3 , 0.5 , 0.15, 0.52, 0.22, 0   , 0   , 0   , 0   , 0   , 0   , 0   ],
                                       [0   , 0.28, 0.18, 0.32, 0.37, 0.29, 0.18, 0.32, 0.37, 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   ],
                                       [0   , 0.78, 1.39, 0.69, 0.91, 0.83, 1.29, 0.51, 0.51, 0.63, 1.25, 0.52, 0.91, 0.96, 0   , 0   , 0   ],
                                       [0   , 0.56, 0.68, 0.42, 0.41, 0.64, 0.68, 0.42, 0.41, 0.73, 0.94, 0.42, 0.41, 0   , 0   , 0   , 0   ],
                                       [0.39, 0.3 , 0.5 , 0.15, 0.52, 0.29, 0.5 , 0.15, 0.52, 0.28, 0.45, 0.28, 0.52, 0   , 0   , 0   , 0   ],
                                       [0   , 0.29, 0.18, 0.32, 0.37, 0.29, 0.18, 0.32, 0.37, 0   , 0.18, 0.33, 0.37, 0   , 0   , 0   , 0   ],
                                       [0.76, 0.47, 1.25, 0.52, 0.91, 0.38, 1.25, 0.52, 0.91, 0.75, 1.2 , 0.52, 1.31, 0.4 , 2.5 , 0.52, 1.31],
                                       [0   , 0   , 0.51, 0   , 0   , 0   , 0.94, 0.42, 0.41, 0.81, 1.19, 0.41, 0.41, 0.81, 1.19, 0.41, 0.41],
                                       [0.31, 0.25, 0   , 0.39, 0   , 0.28, 0.45, 0.28, 0.52, 0.27, 0.4 , 0.4 , 0.52, 0.27, 0.4 , 0.4 , 0.52],
                                       [0   , 0   , 0   , 0   , 0   , 0.29, 0.18, 0.33, 0.37, 0.28, 0.18, 0.33, 0.37, 0.28, 0.18, 0.33, 0.37],
                                       [0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0.23, 2.5 , 0.52, 1.31, 0.94, 3.8 , 0.52, 1.31],
                                       [0   , 0.81, 0   , 0   , 0   , 0.81, 0   , 0   , 0   , 0.81, 1.19, 0.41, 0.41, 0.81, 1.19, 0.41, 0.41],
                                       [0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0.27, 0.4 , 0.4 , 0.52, 0.27, 0.4 , 0.4 , 0.52],
                                       [0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0   , 0.28, 0.18, 0.33, 0.37, 0.28, 0.18, 0.33, 0.37]])
    
    
    #######################################
    ## Background stimulation parameters ##
    #######################################
    # 4.928921885732365,
    # 2.686377916761777, 4.51858066887819, 2.149642324556923, 4.946103075445058,
    # 4.252660578581856, 7.0, 1e-24, 2.7404290734571073,
    # 1e-24, 3.2543403859854227, 0.641944589590017, 2.1834687407340443,
    # 7.0, 1e-24, 2.986536780670069, 0.5803055054744614
    
    params['ext_rate']    = 0.6243191217570061
    params['ext_nodes']   = np.array([1400, 1000, 1400, 1200, 1100, 1500, 1800, 1800, 1800, 1700, 1900, 1900, 1900, 2600, 2100, 2100, 2100])
    params['ext_weights'] = [1.7965744951318477, 
                             3.462524932070633, 2.818597965224434, 2.247184199171211, 3.9053839597064073, 
                             2.85422324169895, 5.841405598126207, 4.897362276797087, 5.427810123924406, 
                             1.2781009467815937, 0.49233409130867667, 3.3180440299163823, 2.444171890699541, 
                             5.760764434899142, 3.42695472801618, 3.777543770653454, 6.266822560118546]
    
    ## Write parameters to file so the network can read it in
    with open("params", 'wb') as f:
        pickle.dump(params, f)
    return params